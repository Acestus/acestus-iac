name: Reusable PR validation (PowerShell)

on:
  workflow_call:
    inputs:
      environment:
        type: string
        default: dev
      resource_group_name:
        type: string
        required: true
      template_file:
        type: string
        default: infrastructure/main.bicep
      params_file:
        type: string
        default: infrastructure/main.dev.bicepparam
      functions_json:
        type: string
        default: '[]'
      powershell_version:
        type: string
        default: '7.4'
      run_tests:
        type: boolean
        default: true
      azure_client_id:
        type: string
        required: true
      azure_tenant_id:
        type: string
        required: true
      azure_subscription_id:
        type: string
        required: true

permissions:
  id-token: write
  contents: read
  pull-requests: write

concurrency:
  group: pr-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  validate:
    runs-on: ubuntu-24.04

    env:
      RESOURCE_GROUP_NAME: ${{ inputs.resource_group_name }}
      TEMPLATE_FILE: ${{ inputs.template_file }}
      PARAMS_FILE: ${{ inputs.params_file }}
      FUNCTIONS_JSON: ${{ inputs.functions_json }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login with OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ inputs.azure_client_id }}
          tenant-id: ${{ inputs.azure_tenant_id }}
          subscription-id: ${{ inputs.azure_subscription_id }}
          auth-type: SERVICE_PRINCIPAL
          audience: api://AzureADTokenExchange

      - name: Validate Bicep template
        id: bicep_validate
        run: |
          echo "## Bicep Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if az bicep build --file "$TEMPLATE_FILE" 2>&1; then
            echo "✅ Bicep build successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Bicep build failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: What-If deployment
        id: whatif
        run: |
          echo "## What-If Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '\`\`\`' >> $GITHUB_STEP_SUMMARY

          az deployment group what-if \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --template-file "$TEMPLATE_FILE" \
            --parameters "$PARAMS_FILE" \
            --no-pretty-print 2>&1 | tee whatif.txt

          cat whatif.txt >> $GITHUB_STEP_SUMMARY
          echo '\`\`\`' >> $GITHUB_STEP_SUMMARY

      - name: Run Pester tests
        if: ${{ inputs.run_tests }}
        shell: pwsh
        run: |
          # Install Pester if not already installed
          if (-not (Get-Module -ListAvailable -Name Pester)) {
            Install-Module -Name Pester -Force -SkipPublisherCheck
          }
          
          # Find and run all Pester tests
          $testFiles = Get-ChildItem -Recurse -Filter "*.Tests.ps1"
          if ($testFiles) {
            $config = New-PesterConfiguration
            $config.Run.Exit = $true
            $config.CodeCoverage.Enabled = $true
            $config.TestResult.Enabled = $true
            
            Invoke-Pester -Configuration $config
          } else {
            Write-Host "No Pester tests found"
          }

      - name: Validate PowerShell functions
        if: ${{ inputs.functions_json != '[]' }}
        shell: pwsh
        run: |
          "## Function Validation" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY

          $functions = $env:FUNCTIONS_JSON | ConvertFrom-Json
          $errors = @()

          foreach ($fn in $functions) {
            $path = $fn.path
            $name = $fn.name
            
            # Check for requirements.psd1 (PowerShell module manifest)
            $reqFile = Join-Path $path "requirements.psd1"
            if (Test-Path $reqFile) {
              try {
                $requirements = Import-PowerShellDataFile $reqFile
                
                # Validate required modules
                foreach ($module in $requirements.Keys) {
                  $moduleVersion = $requirements[$module]
                  Write-Host "Checking module: $module (version $moduleVersion)"
                  
                  # Try to import or install the module
                  if (-not (Get-Module -ListAvailable -Name $module)) {
                    Write-Host "Module $module not found, attempting to install..."
                    Install-Module -Name $module -RequiredVersion $moduleVersion -Force -SkipPublisherCheck -ErrorAction Stop
                  }
                }
              }
              catch {
                $errors += "${name}: Failed to validate requirements - $($_.Exception.Message)"
                continue
              }
            }
            
            # Validate all PowerShell scripts
            $psFiles = Get-ChildItem -Path $path -Recurse -Filter "*.ps1" -File
            foreach ($psFile in $psFiles) {
              $syntaxErrors = $null
              $null = [System.Management.Automation.PSParser]::Tokenize(
                (Get-Content $psFile.FullName -Raw),
                [ref]$syntaxErrors
              )
              
              if ($syntaxErrors.Count -gt 0) {
                $errors += "$($psFile.FullName): Syntax errors found"
                foreach ($err in $syntaxErrors) {
                  Write-Host "  Error: $($err.Message) at line $($err.StartLine)"
                }
              }
            }
          }

          if ($errors.Count -gt 0) {
            "❌ Function validation failed:" >> $env:GITHUB_STEP_SUMMARY
            foreach ($e in $errors) {
              "  - $e" >> $env:GITHUB_STEP_SUMMARY
            }
            Write-Error "Function validation failed"
            exit 1
          }
          else {
            "✅ All functions validated successfully" >> $env:GITHUB_STEP_SUMMARY
            Write-Host "✅ All functions validated successfully"
          }

      - name: Validation Summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
